@startuml precompute state diagram

[*] -[#green]-> PENDING : enqueue, attempts = 0

PENDING -[#green]-> PROCESSING : worker, attempts += 1

PROCESSING -[#green]-> PROCESSING : worker, heartbeat = now

PROCESSING -[#green]-> COMPLETE : worker
PROCESSING -[#green]-> RETRYABLE_FAILURE : worker, transient exception
PROCESSING -[#green]-> FAILED : worker

PROCESSING -[#red]-> RETRYABLE_FAILURE: reaper, if heartbeat expired

RETRYABLE_FAILURE -[#red]-> PENDING : reaper, if attempts < max_tries
RETRYABLE_FAILURE -[#red]-> FAILED : reaper, if attempts == max_tries

COMPLETE -[#green]-> [*]
FAILED -[#green]-> [*]

@enduml
